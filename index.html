<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>La Roche Posay</title>
		<style>
			body {
				margin: 0;
				padding: 0;
				width: 100vw;
				height: 100vh;
				overflow: hidden;
			}

			.main-container {
				width: 100%;
				height: 100%;
				display: flex;
				justify-content: center;
				align-items: center;
			}

			.slide-page {
				position: absolute;
				top: 0;
				left: 0;
				opacity: 0;
				pointer-events: none;
				transition: opacity 0.7s;
			}

			.slide-page.active {
				opacity: 1;
				pointer-events: auto;
				/* z-index: 1; */
			}

			.slide-content {
				position: absolute;
				width: 1920px;
				height: 1080px;
				overflow: hidden;
				box-shadow: 0 8px 40px 8px rgba(0, 0, 0, 0.5), 0 1.5px 8px 0 rgba(0, 0, 0, 0.25);
			}

			/* Page 1 elements */

			.start-btn {
				position: absolute;
				top: 55%;
				left: 50%;
				transform: translate(-50%, -50%);
				border: none;
				background: none;
				padding: 0;
				cursor: pointer;
				outline: none;
				z-index: 2;
				animation: pulse 1.8s infinite;
			}
			.start-btn img {
				display: block;
				/* width: 20%; */
				/* height: auto; */
				pointer-events: none;
				user-select: none;
			}

			@keyframes pulse {
				0% {
					transform: translate(-50%, -50%) scale(1);
				}
				50% {
					transform: translate(-50%, -50%) scale(1.08);
				}
				100% {
					transform: translate(-50%, -50%) scale(1);
				}
			}

			/* Page 2 elements */

			.drop-target {
				position: absolute;
				left: 50%;
				top: 50%;
				width: 300px;
				height: 300px;
				transform: translate(-50%, -50%);
				background: rgba(255, 255, 255, 0.08);
				border: 2px dashed #fff;
				border-radius: 50%;
				z-index: 5;
				pointer-events: none;
				animation: drop-target-pulse 1.2s infinite ease-in-out;
			}

			@keyframes drop-target-pulse {
				0% {
					transform: translate(-50%, -50%) scale(1);
					opacity: 0.7;
				}
				50% {
					transform: translate(-50%, -50%) scale(1.15);
					opacity: 1;
				}
				100% {
					transform: translate(-50%, -50%) scale(1);
					opacity: 0.7;
				}
			}

			.bottle-img {
				position: absolute;
				bottom: 70px;
				right: 70px;
				width: 170px;
				height: auto;
				pointer-events: none;
			}

			.dropper-img {
				position: absolute;
				top: 450px;
				left: 1700px;
				width: 140px;
				height: auto;
				cursor: grab;
				touch-action: none;
				z-index: 20;
				animation: dropper-pulse 2s infinite ease-in-out;
			}

			@keyframes dropper-pulse {
				0% {
					transform: translateY(0);
				}
				50% {
					transform: translateY(-40px);
				}
				100% {
					transform: translateY(0);
				}
			}

			/* Page 4pre */

			.instructions {
				position: absolute;
				top: 30%;
				left: 35%;
				/* pointer-events: none; */
				/* user-select: none; */
				animation: instructions-wiggle 4s infinite linear;
			}

			@keyframes instructions-wiggle {
				0% {
					transform: translateX(0);
				}
				5% {
					transform: translateX(-12px);
				}
				10% {
					transform: translateX(12px);
				}
				15% {
					transform: translateX(-10px);
				}
				20% {
					transform: translateX(10px);
				}
				25% {
					transform: translateX(-6px);
				}
				30% {
					transform: translateX(6px);
				}
				35% {
					transform: translateX(0);
				}
				100% {
					transform: translateX(0);
				}
			}

			/* Page 4 elements */

			.endingbkg {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				transition: opacity 0.5s;
			}

			.congratsImage {
				position: absolute;
				top: 36%;
				left: 40%;
				transition: opacity 0.5s;
			}

			.sidepanel {
				position: absolute;
				top: 0;
				right: 0;
				transition: opacity 0.5s;
				opacity: 0;
			}

			.melasyl {
				position: absolute;
				/* top and left will be set inline for each instance */
				width: 150px;
				height: auto;
				animation: melasyl-pulse 1.5s infinite ease-in-out;
				cursor: grab;
				user-select: none;
				/* border: 2px solid rgba(255, 0, 0, 1); */
			}

			@keyframes melasyl-pulse {
				0% {
					transform: scale(1);
				}
				50% {
					transform: scale(1.15);
				}
				100% {
					transform: scale(1);
				}
			}

			.drop-target-a {
				position: absolute;
				left: 50%;
				top: 50%;
				width: 300px;
				height: 300px;
				transform: translate(-50%, -50%);
				/* background: rgba(61, 214, 47, 0.541); */
				/* z-index: 5; */
				pointer-events: none;
			}

			/* Page 5 elements */
			.bkg {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				transition: opacity 0.5s;
			}
		</style>
	</head>
	<body>
		<audio id="audioCorrect" src="Correct.mp3" preload="auto"></audio>
		<audio id="audioIncorrect" src="Incorrect.mp3" preload="auto"></audio>

		<div class="main-container">
			<div class="slide-content">
				<!-- Page 1 -->
				<div class="slide-page active" id="page1">
					<img src="start_bkg.jpeg" alt="Background" draggable="false" />
					<button class="start-btn" onclick="showPage2()">
						<img src="start_button.png" alt="Start" draggable="false" />
					</button>
				</div>

				<!-- Page 2 -->
				<div class="slide-page" id="page2">
					<img src="ready_bkg.jpg" alt="Background" draggable="false" />
					<div class="drop-target" id="dropTarget"></div>
					<img src="bottle.png" alt="Bottle" class="bottle-img" draggable="false" />
					<img src="dropper.png" alt="Dropper" class="dropper-img" draggable="false" />
				</div>

				<!-- Page 3 -->
				<div class="slide-page" id="page3">
					<video id="introVideo" width="100%" height="100%" muted preload="auto">
						<source src="intro_video.mp4" type="video/mp4" />
						Your browser does not support the video tag.
					</video>
				</div>

				<!-- Page 4pre -->
				<div class="slide-page" id="page4pre">
					<img src="game_bkg.png" alt="Background" draggable="false" />
					<img class="instructions" src="instructions.png" alt="Background" draggable="false" onclick="retryGame()" />
				</div>

				<!-- Page 4 -->
				<div class="slide-page" id="page4">
					<img src="game_bkg.png" alt="Background" draggable="false" />
					<img class="sidepanel" id="sidePanel" src="side_panel.png" alt="Background" draggable="false" />

					<div class="drop-target-a" id="dropTargetA" style="top: 15%; left: 45%; width: 500px; height: 150px"></div>
					<div class="drop-target-a" id="dropTargetB" style="top: 50%; left: 35%; width: 200px; height: 300px"></div>

					<!-- Three draggable melasyls -->
					<img class="melasyl" id="melasyl1" src="melasyl.png" alt="Melasyl 1" draggable="false" style="top: 20%; right: 4%" />
					<img class="melasyl" id="melasyl2" src="melasyl.png" alt="Melasyl 2" draggable="false" style="top: 40%; right: 2%" />
					<img class="melasyl" id="melasyl3" src="melasyl.png" alt="Melasyl 3" draggable="false" style="top: 60%; right: 4%" />

					<img id="congratsA" class="congratsImage" src="nice_work1.png" alt="Background" draggable="false" style="display: none" />
					<img id="congratsB" class="congratsImage" src="nice_work2.png" alt="Background" draggable="false" style="display: none" />
					<img id="congratsImage" class="endingbkg" src="congrats.png" alt="Background" draggable="false" style="display: none" />
				</div>

				<!-- Page 5 -->
				<div class="slide-page" id="page5">
					<img src="game_bkg.png" alt="Background" draggable="false" />
					<img class="bkg" src="try_again.png" alt="Background" draggable="false" onclick="retryGame()" />
				</div>

				<!-- Page 6 -->
				<div class="slide-page" id="page6">
					<video id="endVideo" width="100%" height="100%" muted preload="auto">
						<source src="end_video.mp4" type="video/mp4" />
						Your browser does not support the video tag.
					</video>
				</div>
			</div>
		</div>
	</body>
</html>
<script>
	// Make dropper draggable on page 2
	function makeDropperDraggable() {
		const dropper = document.querySelector('#page2 .dropper-img');
		const slideContent = document.querySelector('.slide-content');
		const dropTarget = document.getElementById('dropTarget');

		let isDragging = false;
		let startX,
			startY,
			origX,
			origY,
			scale = 1;

		// Helper to get current position
		function getCurrentPos() {
			const style = window.getComputedStyle(dropper);
			return {
				left: parseInt(style.left || 0, 10) || 0,
				top: parseInt(style.top || 0, 10) || 0,
			};
		}

		function getCurrentScale() {
			const st = window.getComputedStyle(slideContent);
			const tr = st.transform || st.webkitTransform || st.mozTransform;
			if (tr && tr !== 'none') {
				const match = tr.match(/matrix\(([^)]+)\)/);
				if (match) {
					const values = match[1].split(',');
					return parseFloat(values[0]);
				}
			}
			return 1;
		}

		function checkDropTarget() {
			console.log('Checking drop target');
			const dropperRect = dropper.getBoundingClientRect();
			const targetRect = dropTarget.getBoundingClientRect();

			// Check for rect vs rect overlap
			overTarget = dropperRect.left < targetRect.right && dropperRect.right > targetRect.left && dropperRect.top < targetRect.bottom && dropperRect.bottom > targetRect.top;

			if (overTarget) {
				document.getElementById('page2').classList.remove('active');
				document.getElementById('page3').classList.add('active');
				const vid = document.getElementById('introVideo');
				if (vid) {
					vid.play();
				}

				setTimeout(() => {
					document.getElementById('page3').classList.remove('active');
					document.getElementById('page4pre').classList.add('active');
				}, 6000);
			}
		}

		// Mouse events
		dropper.addEventListener('mousedown', function (e) {
			isDragging = true;
			dropper.style.cursor = 'grabbing';
			const pos = getCurrentPos();
			startX = e.clientX;
			startY = e.clientY;
			origX = pos.left;
			origY = pos.top;
			scale = getCurrentScale();
			document.addEventListener('mousemove', onMouseMove);
			document.addEventListener('mouseup', onMouseUp);
		});

		function onMouseMove(e) {
			if (!isDragging) return;
			const dx = (e.clientX - startX) / scale;
			const dy = (e.clientY - startY) / scale;
			dropper.style.left = origX + dx + 'px';
			dropper.style.top = origY + dy + 'px';
			dropper.style.bottom = 'auto';
			dropper.style.right = 'auto';
		}

		function onMouseUp() {
			isDragging = false;
			dropper.style.cursor = 'grab';
			document.removeEventListener('mousemove', onMouseMove);
			document.removeEventListener('mouseup', onMouseUp);

			checkDropTarget();
		}

		// Touch events
		dropper.addEventListener('touchstart', function (e) {
			if (e.touches.length !== 1) return;
			isDragging = true;
			dropper.style.cursor = 'grabbing';
			const pos = getCurrentPos();
			startX = e.touches[0].clientX;
			startY = e.touches[0].clientY;
			origX = pos.left;
			origY = pos.top;
			scale = getCurrentScale();
			document.addEventListener('touchmove', onTouchMove, { passive: false });
			document.addEventListener('touchend', onTouchEnd);
		});

		function onTouchMove(e) {
			if (!isDragging || e.touches.length !== 1) return;
			e.preventDefault();
			const dx = (e.touches[0].clientX - startX) / scale;
			const dy = (e.touches[0].clientY - startY) / scale;
			dropper.style.left = origX + dx + 'px';
			dropper.style.top = origY + dy + 'px';
			dropper.style.bottom = 'auto';
			dropper.style.right = 'auto';
		}

		function onTouchEnd() {
			isDragging = false;
			dropper.style.cursor = 'grab';
			document.removeEventListener('touchmove', onTouchMove);
			document.removeEventListener('touchend', onTouchEnd);
			checkDropTarget();
		}
	}

	function showPage2() {
		const page1 = document.getElementById('page1');
		const page2 = document.getElementById('page2');
		page1.classList.remove('active');
		page2.classList.add('active');
	}

	function retryGame() {
		// Reset melasyl positions
		melasyls.forEach((melasylActor) => {
			const melasyl = melasylActor.element;
			melasylActor.active = true;
			melasyl.style.top = melasylActor.startPos.top;
			melasyl.style.right = melasylActor.startPos.right;
			melasyl.style.left = 'auto';
			melasyl.style.bottom = 'auto';
		});

		gameState.onTargetA = 0;
		gameState.onTargetB = 0;
		gameState.nextCongrats = 0;

		document.getElementById('congratsImage').style.display = 'none';
		document.getElementById('congratsA').style.display = 'none';
		document.getElementById('congratsB').style.display = 'none';

		document.getElementById('page5').classList.remove('active');
		document.getElementById('page4pre').classList.remove('active');
		document.getElementById('page4').classList.add('active');
	}

	function scaleSlideContent() {
		const content = document.querySelector('.slide-content');
		const container = document.querySelector('.main-container');

		const containerWidth = container.clientWidth;
		const containerHeight = container.clientHeight;

		const scaleX = containerWidth / 1920;
		const scaleY = containerHeight / 1080;
		const scale = Math.min(scaleX, scaleY);
		content.style.transform = `scale(${scale})`;
	}
	window.addEventListener('resize', scaleSlideContent);
	window.addEventListener('DOMContentLoaded', scaleSlideContent);

	// Make melasyls draggable on page 4
	function makeMelasylsDraggable() {
		const slideContent = document.querySelector('.slide-content');
		const targetA = document.getElementById('dropTargetA');
		const targetB = document.getElementById('dropTargetB');

		let active = null,
			offsetX,
			offsetY,
			origX,
			origY,
			scale = 1;

		// Helper to get current position
		function getCurrentPos(element) {
			const style = window.getComputedStyle(element);
			return {
				left: parseInt(style.left || 0, 10) || 0,
				top: parseInt(style.top || 0, 10) || 0,
			};
		}

		function getCurrentScale() {
			const st = window.getComputedStyle(slideContent);
			const tr = st.transform || st.webkitTransform || st.mozTransform;
			if (tr && tr !== 'none') {
				const match = tr.match(/matrix\(([^)]+)\)/);
				if (match) {
					const values = match[1].split(',');
					return parseFloat(values[0]);
				}
			}
			return 1;
		}

		melasyls.forEach((melasylActor) => {
			const melasyl = melasylActor.element;

			melasyl.addEventListener('mousedown', function (e) {
				if (!melasylActor.active) return; // Only allow dragging if active
				active = melasylActor;
				melasyl.style.cursor = 'grabbing';
				const pos = getCurrentPos(melasyl);
				startX = e.clientX;
				startY = e.clientY;
				origX = pos.left;
				origY = pos.top;
				scale = getCurrentScale();
				document.addEventListener('mousemove', onMouseMove);
				document.addEventListener('mouseup', onMouseUp);
			});
			melasyl.addEventListener('touchstart', function (e) {
				if (!melasylActor.active) return; // Only allow dragging if active
				if (e.touches.length !== 1) return;
				active = melasylActor;
				const pos = getCurrentPos(melasyl);
				startX = e.touches[0].clientX;
				startY = e.touches[0].clientY;
				origX = pos.left;
				origY = pos.top;
				scale = getCurrentScale();
				melasyl.style.cursor = 'grabbing';
				document.addEventListener('touchmove', onTouchMove, { passive: false });
				document.addEventListener('touchend', onTouchEnd);
			});
		});

		function onMouseMove(e) {
			if (!active) return;
			const dx = (e.clientX - startX) / scale;
			const dy = (e.clientY - startY) / scale;
			active.element.style.left = origX + dx + 'px';
			active.element.style.top = origY + dy + 'px';
			active.element.style.bottom = 'auto';
			active.element.style.right = 'auto';
		}
		function onMouseUp() {
			if (active) active.element.style.cursor = 'grab';
			document.removeEventListener('mousemove', onMouseMove);
			document.removeEventListener('mouseup', onMouseUp);
			checkDropTarget();
			active = null;
		}
		function onTouchMove(e) {
			if (!active || e.touches.length !== 1) return;
			e.preventDefault();
			const dx = (e.touches[0].clientX - startX) / scale;
			const dy = (e.touches[0].clientY - startY) / scale;
			let newLeft = offsetX + dx;
			let newTop = offsetY + dy;
			active.element.style.left = origX + dx + 'px';
			active.element.style.top = origY + dy + 'px';
			active.element.style.bottom = 'auto';
			active.element.style.right = 'auto';
		}
		function onTouchEnd() {
			if (active) active.element.style.cursor = 'grab';
			document.removeEventListener('touchmove', onTouchMove);
			document.removeEventListener('touchend', onTouchEnd);
			checkDropTarget();
			active = null;
		}

		function checkDropTarget() {
			const targetARect = targetA.getBoundingClientRect();
			const targetBRect = targetB.getBoundingClientRect();
			const activeRect = active.element.getBoundingClientRect();

			// Check for rect vs rect overlap
			const overTargetA = activeRect.left < targetARect.right && activeRect.right > targetARect.left && activeRect.top < targetARect.bottom && activeRect.bottom > targetARect.top;
			const overTargetB = activeRect.left < targetBRect.right && activeRect.right > targetBRect.left && activeRect.top < targetBRect.bottom && activeRect.bottom > targetBRect.top;

			if (overTargetA) {
				console.log('Melasyl dropped in target A');

				if (gameState.onTargetA == 2) {
					document.getElementById('audioIncorrect').currentTime = 0;
					document.getElementById('audioIncorrect').play();
					document.getElementById('page4').classList.remove('active');
					document.getElementById('page5').classList.add('active');
					return;
				}

				gameState.onTargetA++;
				active.active = false;
			} else if (overTargetB) {
				console.log('Melasyl dropped in target B');

				if (gameState.onTargetB == 1) {
					document.getElementById('audioIncorrect').currentTime = 0;
					document.getElementById('audioIncorrect').play();
					document.getElementById('page4').classList.remove('active');
					document.getElementById('page5').classList.add('active');
					return;
				}

				gameState.onTargetB++;
				active.active = false;
			} else {
				console.log('Melasyl not dropped in any target');
				document.getElementById('audioIncorrect').currentTime = 0;
				document.getElementById('audioIncorrect').play();
				document.getElementById('page4').classList.remove('active');
				document.getElementById('page5').classList.add('active');
				return;
			}

			if (gameState.onTargetA == 2 && gameState.onTargetB == 1) {
				congratsImages[0].style.opacity = '0';
				congratsImages[1].style.opacity = '0';

				document.getElementById('audioCorrect').currentTime = 0;
				document.getElementById('audioCorrect').play();

				const congrats = document.getElementById('congratsImage');
				congrats.style.display = 'block';
				congrats.style.opacity = '0';
				setTimeout(() => {
					congrats.style.opacity = '1';
				}, 10);
				setTimeout(() => {
					congrats.style.opacity = '0';
					document.getElementById('page4').classList.remove('active');
					document.getElementById('page6').classList.add('active');
					const endVideo = document.getElementById('endVideo');
					if (endVideo) endVideo.play();
					endVideo.addEventListener('ended', () => {
						// Restore dropper position
						const dropper = document.querySelector('#page2 .dropper-img');
						dropper.style.top = dropperStartPos.top;
						dropper.style.left = dropperStartPos.left;

						document.getElementById('page6').classList.remove('active');
						document.getElementById('page1').classList.add('active');
					});
				}, 2000);
			} else {
				const congrats = congratsImages[gameState.nextCongrats++];

				if (gameState.nextCongrats == 2) {
					congratsImages[0].style.opacity = '0';
				}

				document.getElementById('audioCorrect').currentTime = 0;
				document.getElementById('audioCorrect').play();

				congrats.style.display = 'block';
				congrats.style.opacity = '0';
				setTimeout(() => {
					congrats.style.opacity = '1';
					document.getElementById('sidePanel').style.opacity = '1';
				}, 10);
				setTimeout(() => {
					congrats.style.opacity = '0';
					document.getElementById('sidePanel').style.opacity = '0';
				}, 2000);
			}
		}
	}

	const gameState = {
		onTargetA: 0,
		onTargetB: 0,
		nextCongrats: 0,
	};

	const congratsImages = [document.getElementById('congratsA'), document.getElementById('congratsB')];

	const melasyls = [
		{
			startPos: { top: '20%', right: '4%' },
			active: true,
			element: document.getElementById('melasyl1'),
		},
		{
			startPos: { top: '40%', right: '2%' },
			active: true,
			element: document.getElementById('melasyl2'),
		},
		{
			startPos: { top: '60%', right: '4%' },
			active: true,
			element: document.getElementById('melasyl3'),
		},
	];

	const dropperStartPos = { top: '450px', left: '1700px' };

	// Initialize melasyl drag when page 4 is shown
	document.addEventListener('DOMContentLoaded', function () {
		makeDropperDraggable();
		makeMelasylsDraggable();
	});
</script>
